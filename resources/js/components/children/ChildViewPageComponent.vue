<template>
  <div id="child-view-page-container">
    
    <div v-if="child" class="row">
      <transition name="fade">
        <div class="col-lg-4 offset-lg-4 mb-5">
          <div class="text-center">
            <div class="child-img position-relative">
              <img id="child-avatar" class="child-hero-img object-fit-cover rounded-circle mb-4 animate__bounceIn" :src="$avatarOrDefault(child.image_path)" alt="" width="100%">

              <div class="splat animate__bounce">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                width="750px" height="750px" viewBox="0 0 1280.000000 974.000000"
                preserveAspectRatio="xMidYMid meet">
                <metadata>
                Created by potrace 1.15, written by Peter Selinger 2001-2017
                </metadata>
                <g class="splat-svg" transform="translate(0.000000,974.000000) scale(0.100000,-0.100000)"
                fill="#000000" stroke="none">
                <path d="M12560 9721 c-79 -25 -220 -100 -356 -190 -258 -169 -624 -457 -1502
                -1184 -683 -565 -871 -719 -1197 -983 -1076 -868 -2099 -1639 -3045 -2294
                -180 -125 -629 -430 -632 -430 -2 0 -3 33 -3 73 0 60 -5 80 -27 118 -34 58
                -100 118 -139 126 l-29 6 78 76 c149 145 222 282 287 537 2 6 29 20 62 33 237
                90 383 279 383 496 0 142 -46 251 -150 356 -129 130 -313 180 -521 140 l-66
                -13 -79 64 c-44 34 -90 70 -104 79 l-25 17 39 38 c57 56 88 130 88 212 0 117
                -32 201 -107 281 -69 74 -122 96 -230 96 -78 0 -98 -4 -152 -29 -77 -35 -153
                -113 -191 -193 -23 -50 -27 -71 -27 -150 l0 -92 -55 -6 c-211 -22 -357 -76
                -510 -188 -124 -91 -251 -247 -331 -407 -22 -44 -42 -80 -43 -80 -2 0 -23 7
                -47 16 -68 24 -312 82 -434 104 -134 23 -267 37 -441 46 l-131 7 15 49 c21 72
                12 262 -16 348 -137 418 -645 581 -994 320 -270 -202 -339 -617 -147 -885 18
                -25 30 -47 28 -49 -2 -2 -47 -22 -99 -46 -612 -272 -1142 -809 -1429 -1447
                -508 -1130 -317 -2419 513 -3458 103 -129 372 -398 502 -501 502 -401 1011
                -624 1624 -710 173 -25 598 -25 795 -1 548 68 1007 243 1393 531 295 221 558
                528 737 862 l38 72 196 5 c178 4 207 7 313 35 334 87 595 281 744 554 29 52
                43 68 59 68 12 0 34 9 49 21 32 25 34 64 5 95 l-21 22 21 84 c62 251 50 544
                -30 751 -11 26 -19 51 -19 56 0 4 24 11 54 14 155 16 280 162 263 308 -12 95
                -75 182 -165 226 -47 23 -70 28 -132 27 -118 0 -202 -49 -251 -146 l-20 -39
                -53 48 c-66 61 -196 148 -308 208 l-86 46 29 82 c17 45 46 120 66 167 19 47
                40 97 46 112 9 21 16 26 33 22 43 -11 71 48 38 80 -14 14 -9 26 47 123 115
                201 209 330 629 862 l105 133 330 257 c517 403 1042 797 1605 1205 274 198
                353 255 1290 919 388 275 816 581 951 680 709 515 1037 812 1108 1002 27 71
                26 108 -1 156 -38 68 -111 85 -218 50z m-5682 -4838 c-119 -171 -428 -635
                -549 -826 -41 -64 -79 -115 -85 -113 -7 3 -44 8 -83 12 l-71 7 44 29 c89 58
                154 151 181 257 17 63 15 87 -11 201 -5 23 22 48 302 280 169 140 321 267 338
                282 17 15 34 28 38 28 3 0 -43 -71 -104 -157z"/>
                <path d="M6430 8322 c-89 -30 -141 -61 -196 -118 -99 -101 -138 -233 -110
                -373 26 -128 78 -228 192 -368 24 -30 44 -61 44 -69 0 -32 55 -121 106 -170
                32 -31 85 -68 131 -91 72 -36 83 -38 167 -38 79 0 98 4 142 27 129 68 193 210
                165 363 -6 33 -30 97 -52 142 -35 69 -41 88 -36 124 8 61 -10 214 -34 288 -39
                123 -122 220 -227 269 -75 34 -212 41 -292 14z"/>
                <path d="M4685 7836 c-44 -20 -72 -55 -86 -107 -11 -41 -10 -53 5 -93 25 -65
                71 -99 139 -99 67 -1 111 23 137 73 38 74 19 168 -43 212 -37 26 -111 33 -152
                14z"/>
                <path d="M7725 7091 c-43 -26 -62 -51 -74 -96 -18 -69 8 -143 62 -175 41 -26
                127 -27 169 -2 66 38 90 156 45 223 -43 65 -140 89 -202 50z"/>
                <path d="M8460 5131 c-102 -54 -100 -214 3 -268 69 -36 164 -13 211 50 30 40
                29 131 -2 174 -43 61 -142 82 -212 44z"/>
                <path d="M9987 5026 c-84 -31 -157 -102 -187 -181 l-10 -27 -29 40 c-82 112
                -292 130 -395 34 -104 -98 -102 -304 4 -425 24 -27 60 -53 92 -67 129 -55 305
                -4 348 101 7 16 15 29 19 29 3 0 18 -18 33 -39 30 -42 112 -101 167 -119 49
                -17 160 -15 216 4 69 24 137 94 165 169 18 49 21 75 18 145 -7 143 -76 257
                -193 318 -62 31 -187 41 -248 18z"/>
                <path d="M7353 4705 c-26 -18 -43 -71 -36 -108 18 -94 167 -92 188 3 8 35 -16
                95 -43 109 -30 16 -84 13 -109 -4z"/>
                <path d="M9741 4147 c-49 -17 -76 -58 -76 -117 0 -61 27 -100 83 -120 37 -13
                47 -13 84 0 55 20 81 57 81 114 0 51 -21 89 -61 109 -43 22 -75 26 -111 14z"/>
                <path d="M9217 3340 c-89 -23 -163 -83 -208 -172 -33 -64 -38 -194 -11 -271
                27 -77 81 -141 145 -174 68 -35 199 -44 275 -19 259 86 276 498 26 613 -60 27
                -166 38 -227 23z"/>
                <path d="M8200 1811 c-188 -58 -282 -279 -197 -464 34 -74 87 -130 150 -158
                43 -20 68 -24 147 -24 83 1 101 4 146 27 73 38 130 107 154 186 26 82 25 143
                -1 228 -27 89 -106 171 -188 197 -55 17 -166 21 -211 8z"/>
                </g>
                </svg>
              </div>

              <div class="splat-2 animate__bounce">
                <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
                width="750px" height="750px" viewBox="0 0 1280.000000 974.000000"
                preserveAspectRatio="xMidYMid meet">
                <metadata>
                Created by potrace 1.15, written by Peter Selinger 2001-2017
                </metadata>
                <g class="splat-svg" transform="translate(0.000000,974.000000) scale(0.100000,-0.100000)"
                fill="#000000" stroke="none">
                <path d="M12560 9721 c-79 -25 -220 -100 -356 -190 -258 -169 -624 -457 -1502
                -1184 -683 -565 -871 -719 -1197 -983 -1076 -868 -2099 -1639 -3045 -2294
                -180 -125 -629 -430 -632 -430 -2 0 -3 33 -3 73 0 60 -5 80 -27 118 -34 58
                -100 118 -139 126 l-29 6 78 76 c149 145 222 282 287 537 2 6 29 20 62 33 237
                90 383 279 383 496 0 142 -46 251 -150 356 -129 130 -313 180 -521 140 l-66
                -13 -79 64 c-44 34 -90 70 -104 79 l-25 17 39 38 c57 56 88 130 88 212 0 117
                -32 201 -107 281 -69 74 -122 96 -230 96 -78 0 -98 -4 -152 -29 -77 -35 -153
                -113 -191 -193 -23 -50 -27 -71 -27 -150 l0 -92 -55 -6 c-211 -22 -357 -76
                -510 -188 -124 -91 -251 -247 -331 -407 -22 -44 -42 -80 -43 -80 -2 0 -23 7
                -47 16 -68 24 -312 82 -434 104 -134 23 -267 37 -441 46 l-131 7 15 49 c21 72
                12 262 -16 348 -137 418 -645 581 -994 320 -270 -202 -339 -617 -147 -885 18
                -25 30 -47 28 -49 -2 -2 -47 -22 -99 -46 -612 -272 -1142 -809 -1429 -1447
                -508 -1130 -317 -2419 513 -3458 103 -129 372 -398 502 -501 502 -401 1011
                -624 1624 -710 173 -25 598 -25 795 -1 548 68 1007 243 1393 531 295 221 558
                528 737 862 l38 72 196 5 c178 4 207 7 313 35 334 87 595 281 744 554 29 52
                43 68 59 68 12 0 34 9 49 21 32 25 34 64 5 95 l-21 22 21 84 c62 251 50 544
                -30 751 -11 26 -19 51 -19 56 0 4 24 11 54 14 155 16 280 162 263 308 -12 95
                -75 182 -165 226 -47 23 -70 28 -132 27 -118 0 -202 -49 -251 -146 l-20 -39
                -53 48 c-66 61 -196 148 -308 208 l-86 46 29 82 c17 45 46 120 66 167 19 47
                40 97 46 112 9 21 16 26 33 22 43 -11 71 48 38 80 -14 14 -9 26 47 123 115
                201 209 330 629 862 l105 133 330 257 c517 403 1042 797 1605 1205 274 198
                353 255 1290 919 388 275 816 581 951 680 709 515 1037 812 1108 1002 27 71
                26 108 -1 156 -38 68 -111 85 -218 50z m-5682 -4838 c-119 -171 -428 -635
                -549 -826 -41 -64 -79 -115 -85 -113 -7 3 -44 8 -83 12 l-71 7 44 29 c89 58
                154 151 181 257 17 63 15 87 -11 201 -5 23 22 48 302 280 169 140 321 267 338
                282 17 15 34 28 38 28 3 0 -43 -71 -104 -157z"/>
                <path d="M6430 8322 c-89 -30 -141 -61 -196 -118 -99 -101 -138 -233 -110
                -373 26 -128 78 -228 192 -368 24 -30 44 -61 44 -69 0 -32 55 -121 106 -170
                32 -31 85 -68 131 -91 72 -36 83 -38 167 -38 79 0 98 4 142 27 129 68 193 210
                165 363 -6 33 -30 97 -52 142 -35 69 -41 88 -36 124 8 61 -10 214 -34 288 -39
                123 -122 220 -227 269 -75 34 -212 41 -292 14z"/>
                <path d="M4685 7836 c-44 -20 -72 -55 -86 -107 -11 -41 -10 -53 5 -93 25 -65
                71 -99 139 -99 67 -1 111 23 137 73 38 74 19 168 -43 212 -37 26 -111 33 -152
                14z"/>
                <path d="M7725 7091 c-43 -26 -62 -51 -74 -96 -18 -69 8 -143 62 -175 41 -26
                127 -27 169 -2 66 38 90 156 45 223 -43 65 -140 89 -202 50z"/>
                <path d="M8460 5131 c-102 -54 -100 -214 3 -268 69 -36 164 -13 211 50 30 40
                29 131 -2 174 -43 61 -142 82 -212 44z"/>
                <path d="M9987 5026 c-84 -31 -157 -102 -187 -181 l-10 -27 -29 40 c-82 112
                -292 130 -395 34 -104 -98 -102 -304 4 -425 24 -27 60 -53 92 -67 129 -55 305
                -4 348 101 7 16 15 29 19 29 3 0 18 -18 33 -39 30 -42 112 -101 167 -119 49
                -17 160 -15 216 4 69 24 137 94 165 169 18 49 21 75 18 145 -7 143 -76 257
                -193 318 -62 31 -187 41 -248 18z"/>
                <path d="M7353 4705 c-26 -18 -43 -71 -36 -108 18 -94 167 -92 188 3 8 35 -16
                95 -43 109 -30 16 -84 13 -109 -4z"/>
                <path d="M9741 4147 c-49 -17 -76 -58 -76 -117 0 -61 27 -100 83 -120 37 -13
                47 -13 84 0 55 20 81 57 81 114 0 51 -21 89 -61 109 -43 22 -75 26 -111 14z"/>
                <path d="M9217 3340 c-89 -23 -163 -83 -208 -172 -33 -64 -38 -194 -11 -271
                27 -77 81 -141 145 -174 68 -35 199 -44 275 -19 259 86 276 498 26 613 -60 27
                -166 38 -227 23z"/>
                <path d="M8200 1811 c-188 -58 -282 -279 -197 -464 34 -74 87 -130 150 -158
                43 -20 68 -24 147 -24 83 1 101 4 146 27 73 38 130 107 154 186 26 82 25 143
                -1 228 -27 89 -106 171 -188 197 -55 17 -166 21 -211 8z"/>
                </g>
                </svg>
              </div>

              <transition name="fade">
                <div v-if="isParentOfChild" class="parent-icon">
                  <span class="material-icons" style="font-size:64px">
                    escalator_warning
                  </span>
                </div>
              </transition>
            </div>
            <cloud-card class="text-center">
              <h1>{{child.first_name}} {{child.last_name}}</h1>
              <div class="birthday-badge badge badge-pill badge-primary mb-3 mt-2">
                <span class="material-icons" style="font-size: 17px;">cake</span> {{child.birthday | dateFormatBirthday}}
              </div>
              <h3 class="mb-4">{{$childBirthdayInMonths(child.birthday)}}</h3>
            </cloud-card>
            
            <div class="btn-group">
              <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Manage
              </button>
              <div class="dropdown-menu">
                <a v-if="child.is_admin" class="dropdown-item clickable" @click="$refs.childAddFormComponent.isAdding = true">Edit details</a>
                <a class="dropdown-item clickable" @click="markChildParent(child.id)">
                  {{isParentOfChild ? 'Unmark' : 'Mark'}} as my child
                </a>
              </div>
            </div>
          </div>
        </div>
      </transition>

      <div class="col-lg-6 offset-lg-3">
        <child-add-form-component 
        ref="childAddFormComponent" 
        v-on:eventSaveChild="getChildren(childhash); $refs.childAddFormComponent.isAdding = false"
        :existingChild="child"/>
      </div>

      <!-- Caretakers -->
      <div class="col-lg-12 mt-1">
        <page-header-text text="Caretakers"/>
      </div>

      <template v-if="!isAddingCaretaker && caretakers.length > 0">
        <div v-for="caretaker in caretakers" class="col-lg-4 mb-5">
          <div class="card-horizontal">
            <div class="left-box">
              <span class="material-icons">
                account_circle
              </span>
            </div>
            <div class="right-box">
              <h1>{{caretaker.first_name}} {{caretaker.last_name}}</h1>
              <h2>{{caretaker.role}}</h2>
              <div>
                <span :class="{'opacity-30': !caretaker.is_admin, 'text-primary': caretaker.is_admin}" 
                class="material-icons"
                v-tooltip="'Child Management'">
                  admin_panel_settings
                </span>
                <span :class="{'opacity-30': !caretaker.full_access, 'text-primary': caretaker.full_access}" 
                class="material-icons"
                v-tooltip="'Tracker Management'">
                  playlist_add_check
                </span>
              </div>
            </div>
            <div v-if="$currentUser.id !== caretaker.id" class="action-box">
              <!-- <div class="icon clickable" @click="removeCaretaker(childhash, caretaker)">
                <span class="material-icons">
                delete
                </span>
              </div> -->
              <div v-if="child.is_admin" class="dropdown icon">
                <button class="btn btn-default dropdown-toggle" 
                type="button" id="dropdownMenuButton" data-toggle="dropdown" 
                aria-haspopup="true" aria-expanded="false"
                style="padding: 0px 8px;">
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <a @click="isAddingCaretaker = true; selectedCaretaker = caretaker;" class="dropdown-item">Manage Access</a>
                  <a @click="removeCaretaker(childhash, caretaker)" class="dropdown-item" href="#">Remove</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <template v-if="child.is_admin">
          <div v-for="invite in pendingInvites" class="col-lg-4 mb-5">
            <div class="card-horizontal">
              <div class="left-box">
                <span class="material-icons">
                  account_circle
                </span>
                <div class="pending">Pending</div>
              </div>
              <div class="right-box">
                <h1>{{invite.email}}</h1>
                <h2>{{invite.role}}</h2>
                <div>
                  <span :class="{'opacity-30': !invite.is_admin, 'text-primary': invite.is_admin}" 
                  class="material-icons"
                  v-tooltip="'Child Management'">
                    admin_panel_settings
                  </span>
                  <span :class="{'opacity-30': !invite.full_access, 'text-primary': invite.full_access}" 
                  class="material-icons"
                  v-tooltip="'Tracker Management'">
                    playlist_add_check
                  </span>
                </div>
              </div>
              <div class="action-box">
                <div class="icon clickable" @click="deleteInvite(invite, childhash)">
                  <span class="material-icons">
                  delete
                  </span>
                </div>
              </div>
            </div>
          </div>
        
          <div class="col-lg-4 mb-5 clickable" @click="isAddingCaretaker = true;selectedCaretaker = null;">
            <div class="card-horizontal">
              <div class="left-box">
                <span class="material-icons">
                  person_add
                </span>
              </div>
              <div class="right-box">
                <h1 style="padding: 25px 0;">Add New Caretaker</h1>
              </div>
            </div>
          </div>
        </template>
      </template>

      <transition name="fade_in_only">
        <div v-if="isAddingCaretaker" class="col-lg-12">
          <caretaker-add-form-component 
          :childHash="childhash"
          :existingCaretaker="selectedCaretaker"
          v-on:emitSaveInvite="getPendingInvites(childhash);isAddingCaretaker = false;"
          v-on:emitUpdateCaretaker="getCaretakers(childhash);isAddingCaretaker = false;selectedCaretaker = null;">
            <button class="btn btn-default" @click="isAddingCaretaker = false">Cancel</button>
          </caretaker-add-form-component>
        </div>
      </transition>
      
      <div class="col-lg-12">
        <tracker-table-component :childhash="childhash"/>
      </div>

    </div>
  </div>
</template>

<script>
import childrenMixin from '../../mixins/children';
import caretakersMixin from '../../mixins/caretakers';

export default {
  data() {
    return {
      isAddingCaretaker: false,
      isParentOfChild: false,
      selectedCaretaker: null
    }
  },
  props: {
    childhash: {
      type: String,
      required: false,
      default: null
    }
  },

  mixins: [
    childrenMixin,
    caretakersMixin
  ],

  methods: {

  },

  watch: {
    child: function() {
      this.$nextTick(function () {
        Vue.prototype.$keepElSquare('child-avatar');
      })
    }
  },

  mounted() {
    this.getChildren(this.childhash);
    this.getCaretakers(this.childhash);
    this.getPendingInvites(this.childhash);
    this.getIsParentOfChild(this.childhash, Vue.prototype.$currentUser.id);
    
  }
}
</script>

<style lang="scss" scoped>
  .splat {
    animation-duration: 1s;
    animation-name: fadeIn;
    animation-timing-function: ease-in-out;
    position: absolute;
    top: -268px;
    z-index: -1;
    left: 0px;

    .splat-svg {
      fill: #e0d3ec;
    }
  }  

  .splat-2 {
    animation-duration: 1s;
    animation-name: fadeIn;
    animation-timing-function: ease-in-out;
    position: absolute;
    top: -752px;
    z-index: -1;
    left: -74px;
    transform: rotate(
      231deg
    );

    .splat-svg {
      fill: #6eaefc42;
    }
  }  

  @keyframes fadeIn {
    0% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }

  .birthday-badge {
    font-size: 20px;
    background-color: #6eaefc;
    color: white;
    letter-spacing: 2px;
  }
</style>